(()=>{var t,__,i;t=jQuery,__=wp.i18n.__,i=window.imageEdit={iasapi:{},hold:{},postid:"",_view:!1,toggleCropTool:function(e,a,r){var o=t("#image-preview-"+e),n=this.iasapi.getSelection();if(i.toggleControls(r),"false"==("true"===t(r).attr("aria-expanded")?"true":"false"))this.iasapi.cancelSelection(),i.setDisabled(t(".imgedit-crop-clear"),0);else{i.setDisabled(t(".imgedit-crop-clear"),1);var s=t("#imgedit-start-x-"+e).val()?t("#imgedit-start-x-"+e).val():0,d=t("#imgedit-start-y-"+e).val()?t("#imgedit-start-y-"+e).val():0,l=t("#imgedit-sel-width-"+e).val()?t("#imgedit-sel-width-"+e).val():o.innerWidth(),h=t("#imgedit-sel-height-"+e).val()?t("#imgedit-sel-height-"+e).val():o.innerHeight();isNaN(n.x1)&&(this.setCropSelection(e,{x1:s,y1:d,x2:l,y2:h,width:l,height:h}),n=this.iasapi.getSelection()),0===n.x1&&0===n.y1&&0===n.x2&&0===n.y2?(this.iasapi.setSelection(0,0,o.innerWidth(),o.innerHeight(),!0),this.iasapi.setOptions({show:!0}),this.iasapi.update()):(this.iasapi.setSelection(s,d,l,h,!0),this.iasapi.setOptions({show:!0}),this.iasapi.update())}},handleCropToolClick:function(e,a,r){r.classList.contains("imgedit-crop-clear")?(this.iasapi.cancelSelection(),i.setDisabled(t(".imgedit-crop-apply"),0),t("#imgedit-sel-width-"+e).val(""),t("#imgedit-sel-height-"+e).val(""),t("#imgedit-start-x-"+e).val("0"),t("#imgedit-start-y-"+e).val("0"),t("#imgedit-selection-"+e).val("")):i.crop(e,a,r)},intval:function(t){return 0|t},setDisabled:function(t,i){i?t.removeClass("disabled").prop("disabled",!1):t.addClass("disabled").prop("disabled",!0)},init:function(e){var a=this,r=t("#image-editor-"+a.postid);a.postid!==e&&r.length&&a.close(a.postid),a.hold.sizer=parseFloat(t("#imgedit-sizer-"+e).val()),a.postid=e,t("#imgedit-response-"+e).empty(),t("#imgedit-panel-"+e).on("keypress",(function(a){var r=t("#imgedit-nonce-"+e).val();26===a.which&&a.ctrlKey&&i.undo(e,r),25===a.which&&a.ctrlKey&&i.redo(e,r)})),t("#imgedit-panel-"+e).on("keypress",'input[type="text"]',(function(i){var e=i.keyCode;if(36<e&&e<41&&t(this).trigger("blur"),13===e)return i.preventDefault(),i.stopPropagation(),!1})),t(document).on("image-editor-ui-ready",this.focusManager)},calculateImgSize:function(i){var e=this,a=e.intval(t("#imgedit-x-"+i).val()),r=e.intval(t("#imgedit-y-"+i).val());e.hold.w=e.hold.ow=a,e.hold.h=e.hold.oh=r,e.hold.xy_ratio=a/r,e.hold.sizer=parseFloat(t("#imgedit-sizer-"+i).val()),e.currentCropSelection=null},toggleEditor:function(i,e,a){var r=t("#imgedit-wait-"+i);e?r.fadeIn("fast"):r.fadeOut("fast",(function(){a&&t(document).trigger("image-editor-ui-ready")}))},togglePopup:function(i){var e=t(i),a=t(i).attr("aria-controls"),r=t("#"+a);return e.attr("aria-expanded","false"===e.attr("aria-expanded")?"true":"false"),r.toggleClass("imgedit-popup-menu-open").slideToggle("fast").css({"z-index":2e5}),"true"===e.attr("aria-expanded")&&r.find("button").first().trigger("focus"),!1},monitorPopup:function(){var t=document.querySelector(".imgedit-rotate-menu-container"),e=document.querySelector(".imgedit-rotate-menu-container .imgedit-rotate");return setTimeout((function(){var a=document.activeElement,r=t.contains(a);a&&!r&&"true"===e.getAttribute("aria-expanded")&&i.togglePopup(e)}),100),!1},browsePopup:function(i,e){var a=t(e),r=t(e).parent(".imgedit-popup-menu").find("button"),o=r.index(a),n=o-1,s=o+1,d=r.length;n<0&&(n=d-1),s===d&&(s=0);var l=!1;return 40===i.keyCode?l=r.get(s):38===i.keyCode&&(l=r.get(n)),l&&(l.focus(),i.preventDefault()),!1},closePopup:function(i){var e=t(i).parent(".imgedit-popup-menu"),a=e.attr("id");return t('button[aria-controls="'+a+'"]').attr("aria-expanded","false").trigger("focus"),e.toggleClass("imgedit-popup-menu-open").slideToggle("fast"),!1},toggleHelp:function(i){var e=t(i);return e.attr("aria-expanded","false"===e.attr("aria-expanded")?"true":"false").parents(".imgedit-group-top").toggleClass("imgedit-help-toggled").find(".imgedit-help").slideToggle("fast"),!1},toggleControls:function(i){var e=t(i),a=t("#"+e.attr("aria-controls"));return e.attr("aria-expanded","false"===e.attr("aria-expanded")?"true":"false"),a.parent(".imgedit-group").toggleClass("imgedit-panel-active"),!1},getTarget:function(i){var e=t("#imgedit-save-target-"+i);return e.length?e.find('input[name="imgedit-target-'+i+'"]:checked').val()||"full":"all"},scaleChanged:function(i,e,a){var r=t("#imgedit-scale-width-"+i),o=t("#imgedit-scale-height-"+i),n=t("#imgedit-scale-warn-"+i),s="",d="",l=t("#imgedit-scale-button");!1!==this.validateNumeric(a)&&(e?(d=""!==r.val()?Math.round(r.val()/this.hold.xy_ratio):"",o.val(d)):(s=""!==o.val()?Math.round(o.val()*this.hold.xy_ratio):"",r.val(s)),d&&d>this.hold.oh||s&&s>this.hold.ow?(n.css("visibility","visible"),l.prop("disabled",!0)):(n.css("visibility","hidden"),l.prop("disabled",!1)))},getSelRatio:function(i){var e=this.hold.w,a=this.hold.h,r=this.intval(t("#imgedit-crop-width-"+i).val()),o=this.intval(t("#imgedit-crop-height-"+i).val());return r&&o?r+":"+o:e&&a?e+":"+a:"1:1"},filterHistory:function(i,e){var a,r,o,n,s=t("#imgedit-history-"+i).val(),d=[];if(""!==s){if(s=JSON.parse(s),(a=this.intval(t("#imgedit-undone-"+i).val()))>0)for(;a>0;)s.pop(),a--;if(e){if(!s.length)return this.hold.w=this.hold.ow,this.hold.h=this.hold.oh,"";(o=(o=s[s.length-1]).c||o.r||o.f||!1)&&(this.hold.w=o.fw,this.hold.h=o.fh)}for(r in s)(n=s[r]).hasOwnProperty("c")?d[r]={c:{x:n.c.x,y:n.c.y,w:n.c.w,h:n.c.h,r:n.c.r}}:n.hasOwnProperty("r")?d[r]={r:n.r.r}:n.hasOwnProperty("f")&&(d[r]={f:n.f.f});return JSON.stringify(d)}return""},refreshEditor:function(e,a,r){var o,n,s=this;s.toggleEditor(e,1),o={action:"imgedit-preview",_ajax_nonce:a,postid:e,history:s.filterHistory(e,1),rand:s.intval(1e6*Math.random())},n=t('<img id="image-preview-'+e+'" alt="" />').on("load",{history:o.history},(function(a){var o,s,d,l=t("#imgedit-crop-"+e),h=i;""!==a.data.history&&(d=JSON.parse(a.data.history))[d.length-1].hasOwnProperty("c")&&(h.setDisabled(t("#image-undo-"+e),!0),t("#image-undo-"+e).trigger("focus")),l.empty().append(n),o=Math.max(h.hold.w,h.hold.h),s=Math.max(t(n).width(),t(n).height()),h.hold.sizer=o>s?s/o:1,h.initCrop(e,n,l),null!=r&&r(),t("#imgedit-history-"+e).val()&&"0"===t("#imgedit-undone-"+e).val()?t("button.imgedit-submit-btn","#imgedit-panel-"+e).prop("disabled",!1):t("button.imgedit-submit-btn","#imgedit-panel-"+e).prop("disabled",!0);var g=__("Image updated.");h.toggleEditor(e,0),wp.a11y.speak(g,"assertive")})).on("error",(function(){var i=__("Could not load the preview image. Please reload the page and try again.");t("#imgedit-crop-"+e).empty().append('<div class="notice notice-error" tabindex="-1" role="alert"><p>'+i+"</p></div>"),s.toggleEditor(e,0,!0),wp.a11y.speak(i,"assertive")})).attr("src",ajaxurl+"?"+t.param(o))},action:function(i,e,a){var r,o,n,s,d,l=this;if(l.notsaved(i))return!1;if(r={action:"image-editor",_ajax_nonce:e,postid:i},"scale"===a){if(o=t("#imgedit-scale-width-"+i),n=t("#imgedit-scale-height-"+i),s=l.intval(o.val()),d=l.intval(n.val()),s<1)return o.trigger("focus"),!1;if(d<1)return n.trigger("focus"),!1;if(s===l.hold.ow||d===l.hold.oh)return!1;r.do="scale",r.fwidth=s,r.fheight=d}else{if("restore"!==a)return!1;r.do="restore"}l.toggleEditor(i,1),t.post(ajaxurl,r,(function(e){t("#image-editor-"+i).empty().append(e.data.html),l.toggleEditor(i,0,!0),l._view&&l._view.refresh()})).done((function(t){t&&t.data.message.msg?wp.a11y.speak(t.data.message.msg):t&&t.data.message.error&&wp.a11y.speak(t.data.message.error)}))},save:function(e,a){var r,o=this.getTarget(e),n=this.filterHistory(e,0),s=this;if(""===n)return!1;this.toggleEditor(e,1),r={action:"image-editor",_ajax_nonce:a,postid:e,history:n,target:o,context:t("#image-edit-context").length?t("#image-edit-context").val():null,do:"save"},t.post(ajaxurl,r,(function(a){if(a.data.error)return t("#imgedit-response-"+e).html('<div class="notice notice-error" tabindex="-1" role="alert"><p>'+a.data.error+"</p></div>"),i.close(e),void wp.a11y.speak(a.data.error);a.data.fw&&a.data.fh&&t("#media-dims-"+e).html(a.data.fw+" &times; "+a.data.fh),a.data.thumbnail&&t(".thumbnail","#thumbnail-head-"+e).attr("src",""+a.data.thumbnail),a.data.msg&&(t("#imgedit-response-"+e).html('<div class="notice notice-success" tabindex="-1" role="alert"><p>'+a.data.msg+"</p></div>"),wp.a11y.speak(a.data.msg)),s._view?s._view.save():i.close(e)}))},open:function(e,a,r){this._view=r;var o,n=t("#image-editor-"+e),s=t("#media-head-"+e),d=t("#imgedit-open-btn-"+e),l=d.siblings(".spinner");if(!d.hasClass("button-activated"))return l.addClass("is-active"),o={action:"image-editor",_ajax_nonce:a,postid:e,do:"open"},t.ajax({url:ajaxurl,type:"post",data:o,beforeSend:function(){d.addClass("button-activated")}}).done((function(a){var r;"-1"===a&&(r=__("Could not load the preview image."),n.html('<div class="notice notice-error" tabindex="-1" role="alert"><p>'+r+"</p></div>")),a.data&&a.data.html&&n.html(a.data.html),s.fadeOut("fast",(function(){n.fadeIn("fast",(function(){r&&t(document).trigger("image-editor-ui-ready")})),d.removeClass("button-activated"),l.removeClass("is-active")})),i.init(e)}))},imgLoaded:function(i){var e=t("#image-preview-"+i),a=t("#imgedit-crop-"+i);void 0===this.hold.sizer&&this.init(i),this.calculateImgSize(i),this.initCrop(i,e,a),this.setCropSelection(i,{x1:0,y1:0,x2:0,y2:0,width:e.innerWidth(),height:e.innerHeight()}),this.toggleEditor(i,0,!0)},focusManager:function(){setTimeout((function(){var i=t('.notice[role="alert"]');i.length||(i=t(".imgedit-wrap").find(":tabbable:first")),i.attr("tabindex","-1").trigger("focus")}),100)},initCrop:function(e,a,r){var o=this,n=t("#imgedit-sel-width-"+e),s=t("#imgedit-sel-height-"+e),d=t(a);d.data("imgAreaSelect")||(o.iasapi=d.imgAreaSelect({parent:r,instance:!0,handles:!0,keys:!0,minWidth:3,minHeight:3,onInit:function(i){t(i).next().css("position","absolute").nextAll(".imgareaselect-outer").css("position","absolute"),r.children().on("mousedown touchstart",(function(i){var a=!1,r=o.iasapi.getSelection(),n=o.intval(t("#imgedit-crop-width-"+e).val()),s=o.intval(t("#imgedit-crop-height-"+e).val());n&&s?a=o.getSelRatio(e):i.shiftKey&&r&&r.width&&r.height&&(a=r.width+":"+r.height),o.iasapi.setOptions({aspectRatio:a})}))},onSelectStart:function(){i.setDisabled(t("#imgedit-crop-sel-"+e),1),i.setDisabled(t(".imgedit-crop-clear"),1),i.setDisabled(t(".imgedit-crop-apply"),1)},onSelectEnd:function(a,r){i.setCropSelection(e,r),t("#imgedit-crop > *").is(":visible")||i.toggleControls(t(".imgedit-crop.button"))},onSelectChange:function(t,e){var a=i.hold.sizer,r=i.currentCropSelection;null!=r&&r.width==e.width&&r.height==e.height||(n.val(Math.min(i.hold.w,i.round(e.width/a))),s.val(Math.min(i.hold.h,i.round(e.height/a))),o.currentCropSelection=e)}}))},setCropSelection:function(i,e){var a,r=t("#imgedit-sel-width-"+i),o=t("#imgedit-sel-height-"+i),n=this.hold.sizer,s=this.hold;if(!(e=e||0)||e.width<3&&e.height<3)return this.setDisabled(t(".imgedit-crop","#imgedit-panel-"+i),1),this.setDisabled(t("#imgedit-crop-sel-"+i),1),t("#imgedit-sel-width-"+i).val(""),t("#imgedit-sel-height-"+i).val(""),t("#imgedit-start-x-"+i).val("0"),t("#imgedit-start-y-"+i).val("0"),t("#imgedit-selection-"+i).val(""),!1;var d=s.w-(Math.round(e.x1/n)+parseInt(r.val())),l=s.h-(Math.round(e.y1/n)+parseInt(o.val()));a={r:1,x:Math.round(e.x1/n)+Math.min(0,d),y:Math.round(e.y1/n)+Math.min(0,l),w:r.val(),h:o.val()},this.setDisabled(t(".imgedit-crop","#imgedit-panel-"+i),1),t("#imgedit-selection-"+i).val(JSON.stringify(a))},close:function(i,e){if((e=e||!1)&&this.notsaved(i))return!1;this.iasapi={},this.hold={},this._view?this._view.back():t("#image-editor-"+i).fadeOut("fast",(function(){t("#media-head-"+i).fadeIn("fast",(function(){t("#imgedit-open-btn-"+i).trigger("focus")})),t(this).empty()}))},notsaved:function(i){var e=t("#imgedit-history-"+i).val(),a=""!==e?JSON.parse(e):[];return this.intval(t("#imgedit-undone-"+i).val())<a.length&&!confirm(t("#imgedit-leaving-"+i).text())},addStep:function(i,e,a){for(var r=this,o=t("#imgedit-history-"+e),n=""!==o.val()?JSON.parse(o.val()):[],s=t("#imgedit-undone-"+e),d=r.intval(s.val());d>0;)n.pop(),d--;s.val(0),n.push(i),o.val(JSON.stringify(n)),r.refreshEditor(e,a,(function(){r.setDisabled(t("#image-undo-"+e),!0),r.setDisabled(t("#image-redo-"+e),!1)}))},rotate:function(i,e,a,r){if(t(r).hasClass("disabled"))return!1;this.closePopup(r),this.addStep({r:{r:i,fw:this.hold.h,fh:this.hold.w}},e,a),t("#imgedit-sel-width-"+e).val(""),t("#imgedit-sel-height-"+e).val(""),this.currentCropSelection=null},flip:function(i,e,a,r){if(t(r).hasClass("disabled"))return!1;this.closePopup(r),this.addStep({f:{f:i,fw:this.hold.w,fh:this.hold.h}},e,a),t("#imgedit-sel-width-"+e).val(""),t("#imgedit-sel-height-"+e).val(""),this.currentCropSelection=null},crop:function(i,e,a){var r=t("#imgedit-selection-"+i).val(),o=this.intval(t("#imgedit-sel-width-"+i).val()),n=this.intval(t("#imgedit-sel-height-"+i).val());if(t(a).hasClass("disabled")||""===r)return!1;(r=JSON.parse(r)).w>0&&r.h>0&&o>0&&n>0&&(r.fw=o,r.fh=n,this.addStep({c:r},i,e)),t("#imgedit-sel-width-"+i).val(""),t("#imgedit-sel-height-"+i).val(""),t("#imgedit-start-x-"+i).val("0"),t("#imgedit-start-y-"+i).val("0"),this.currentCropSelection=null},undo:function(i,e){var a=this,r=t("#image-undo-"+i),o=t("#imgedit-undone-"+i),n=a.intval(o.val())+1;r.hasClass("disabled")||(o.val(n),a.refreshEditor(i,e,(function(){var e=t("#imgedit-history-"+i),o=""!==e.val()?JSON.parse(e.val()):[];a.setDisabled(t("#image-redo-"+i),!0),a.setDisabled(r,n<o.length),o.length===n&&t("#image-redo-"+i).trigger("focus")})))},redo:function(i,e){var a=this,r=t("#image-redo-"+i),o=t("#imgedit-undone-"+i),n=a.intval(o.val())-1;r.hasClass("disabled")||(o.val(n),a.refreshEditor(i,e,(function(){a.setDisabled(t("#image-undo-"+i),!0),a.setDisabled(r,n>0),0===n&&t("#image-undo-"+i).trigger("focus")})))},setNumSelection:function(i,e){var a,r,o,n,s,d=t("#imgedit-sel-width-"+i),l=t("#imgedit-sel-height-"+i),h=t("#imgedit-start-x-"+i),g=t("#imgedit-start-y-"+i),c=this.intval(h.val()),p=this.intval(g.val()),u=this.intval(d.val()),m=this.intval(l.val()),v=t("#image-preview-"+i),f=v.height(),w=v.width(),y=this.hold.sizer,b=this.iasapi;if(this.currentCropSelection=null,!1!==this.validateNumeric(e))return u<1?(d.val(""),!1):m<1?(l.val(""),!1):void((u&&m||c&&p)&&(a=b.getSelection())&&(n=a.x1+Math.round(u*y),s=a.y1+Math.round(m*y),r=c===a.x1?a.x1:Math.round(c*y),o=p===a.y1?a.y1:Math.round(p*y),n>w&&(r=0,n=w,d.val(Math.min(this.hold.w,Math.round(n/y)))),s>f&&(o=0,s=f,l.val(Math.min(this.hold.h,Math.round(s/y)))),b.setSelection(r,o,n,s),b.update(),this.setCropSelection(i,b.getSelection()),this.currentCropSelection=b.getSelection()))},round:function(t){var i;return t=Math.round(t),this.hold.sizer>.6?t:"1"===(i=t.toString().slice(-1))?t-1:"9"===i?t+1:t},setRatioSelection:function(i,e,a){var r,o,n=this.intval(t("#imgedit-crop-width-"+i).val()),s=this.intval(t("#imgedit-crop-height-"+i).val()),d=t("#image-preview-"+i).height();if(!1!==this.validateNumeric(a)){if(n&&s&&(this.iasapi.setOptions({aspectRatio:n+":"+s}),r=this.iasapi.getSelection(!0))){if((o=Math.ceil(r.y1+(r.x2-r.x1)/(n/s)))>d){o=d;var l=__("Selected crop ratio exceeds the boundaries of the image. Try a different ratio.");t("#imgedit-crop-"+i).prepend('<div class="notice notice-error" tabindex="-1" role="alert"><p>'+l+"</p></div>"),wp.a11y.speak(l,"assertive"),e?t("#imgedit-crop-height-"+i).val(""):t("#imgedit-crop-width-"+i).val("")}else{var h=t("#imgedit-crop-"+i).find(".notice-error");void 0!==h&&h.remove()}this.iasapi.setSelection(r.x1,r.y1,r.x2,o),this.iasapi.update()}}else this.iasapi.setOptions({aspectRatio:null})},validateNumeric:function(i){if(!1===this.intval(t(i).val()))return t(i).val(""),!1}}})();